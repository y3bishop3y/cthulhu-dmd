# Insanity Track Mechanics

## Overview

This document details the insanity/madness track mechanics for Cthulhu: Death May Die characters. This is a critical system that affects power upgrades, tentacle risk, and survival.

---

## Insanity Track Structure

### Track Layout
- **20 slots** (player starts at slot 1)
- **Death threshold:** Slot 21 (one more tentacle = death from madness)
- **Red Swirls (Level-Up Points):** Slots 5, 9, 13, 16, 19, 20 (6 total)
- **Green Dice Bonuses:** Red swirls 2, 4, 5, 6 grant green dice (slots 9, 16, 19, 20)

### Red Swirl Positions
| Red Swirl # | Slot Position | Grants Green Dice? |
|-------------|---------------|-------------------|
| 1 | 5 | No |
| 2 | 9 | **Yes** |
| 3 | 13 | No |
| 4 | 16 | **Yes** |
| 5 | 19 | **Yes** |
| 6 | 20 | **Yes** |

**Total:** 6 level-up opportunities, 4 green dice bonuses

---

## Insanity Progression

### How Insanity Increases
- **Tentacle rolled:** +1 insanity (on any roll)
- **Enemy tentacle:** +1 insanity (when enemies attack)
- **Other effects:** Some cards/effects may add insanity

### ⚠️ CRITICAL RULE: Red Swirl Stop Behavior

**When you hit a red swirl during a roll, you STOP there and don't accumulate tentacles past it for that roll.**

**Example:**
- **Current insanity:** Slot 4
- **Roll 3 tentacles:** Would normally go to slot 7
- **BUT:** Red swirl is at slot 5
- **Result:** Stop at slot 5, gain level-up benefit immediately
- **Remaining tentacles:** Ignored for this roll (don't go to 6, 7)
- **Next roll:** Tentacles matter again until next red swirl

**Why this matters:**
- You get the level-up benefit immediately (can use upgraded power on next action)
- You don't "overshoot" red swirls and waste tentacles
- Each roll/action can only cross one red swirl threshold

### Example Progression

**Normal progression (one tentacle at a time):**
1. Start: Slot 1
2. Roll tentacle: Slot 2
3. Roll tentacle: Slot 3
4. Roll tentacle: Slot 4
5. Roll tentacle: Slot 5 → **Red Swirl 1** (Level-up available!)
6. Roll tentacle: Slot 6
7. ...continue...
9. Roll tentacle: Slot 9 → **Red Swirl 2** (Level-up + Green Dice!)
10. ...continue...
13. Roll tentacle: Slot 13 → **Red Swirl 3** (Level-up available!)
16. Roll tentacle: Slot 16 → **Red Swirl 4** (Level-up + Green Dice!)
19. Roll tentacle: Slot 19 → **Red Swirl 5** (Level-up + Green Dice!)
20. Roll tentacle: Slot 20 → **Red Swirl 6** (Level-up + Green Dice!)
21. Roll tentacle: Slot 21 → **DEATH FROM MADNESS**

**Red swirl stop behavior example:**
- **Action 1:** Attack at slot 4, roll 3 tentacles
  - Would go to slot 7, but stops at slot 5 (red swirl)
  - Gain level-up benefit immediately
  - Remaining 2 tentacles ignored for this action
- **Action 2:** Attack again at slot 5 (with 1 power upgrade)
  - Roll 2 tentacles → goes to slot 7
  - No red swirl in range, so tentacles accumulate normally
- **Action 3:** Attack at slot 7, roll 3 tentacles
  - Would go to slot 10, but stops at slot 9 (red swirl)
  - Gain level-up + green dice benefit immediately
  - Remaining 1 tentacle ignored for this action

---

## Level-Up System

### Key Constraint
- **Only 6 level-ups total** (one per red swirl)
- Player cannot level up every power to max
- Must choose which powers to upgrade strategically

### Level-Up Process
1. Reach a red swirl slot (5, 9, 13, 16, 19, or 20)
2. Choose ONE power to level up (special or common)
3. That power gains +1 level (max level 4 for common powers)
4. If red swirl grants green dice, gain +1 permanent green dice bonus

### Green Dice Bonuses
- **Red Swirl 2 (slot 9):** +1 green dice
- **Red Swirl 4 (slot 16):** +1 green dice
- **Red Swirl 5 (slot 19):** +1 green dice
- **Red Swirl 6 (slot 20):** +1 green dice
- **Total:** Up to 4 permanent green dice bonuses

---

## Impact on Gameplay

### Tentacle Risk Analysis
- **Tentacles = Insanity = Closer to Death**
- Each tentacle brings player 1 slot closer to death
- At slot 20, one tentacle = death
- **Risk increases exponentially** as insanity rises

### Green Dice Value
- **Green dice have NO tentacles** (only successes, elder signs, blanks)
- Green dice = safer rolls = less insanity risk
- Gaining green dice = reducing tentacle probability

### Reroll Value
- **Rerolls can avoid tentacles** or get successes
- High insanity = rerolls become more valuable
- Can reroll tentacles to try for successes/elder signs
- Can reroll blanks to try for successes

### Power Upgrade Strategy
- **Only 6 upgrades total** - must choose carefully
- Early upgrades = more time to benefit
- Late upgrades = less time to benefit
- Must balance offense vs defense vs utility

---

## Examples

### Example 1: Early Game
- **Insanity:** Slot 3
- **Tentacles until Red Swirl 1:** 2 tentacles
- **Strategy:** Can afford to take risks, roll aggressively
- **Upgrade Priority:** Offensive powers (more time to benefit)

### Example 2: Mid Game
- **Insanity:** Slot 12
- **Red Swirls Reached:** 2 (slots 5, 9)
- **Green Dice Bonus:** +1 (from red swirl 2)
- **Tentacles until Red Swirl 3:** 1 tentacle
- **Strategy:** Getting riskier, consider defensive powers
- **Upgrade Priority:** Balanced (some offense, some defense)

### Example 3: Late Game
- **Insanity:** Slot 19
- **Red Swirls Reached:** 5 (slots 5, 9, 13, 16, 19)
- **Green Dice Bonus:** +3 (from red swirls 2, 4, 5)
- **Tentacles until Death:** 2 tentacles
- **Strategy:** Very risky, prioritize survival
- **Upgrade Priority:** Defensive/healing powers

### Example 4: Maximum Power
- **Insanity:** Slot 20
- **Red Swirls Reached:** 6 (all red swirls)
- **Green Dice Bonus:** +4 (all green dice bonuses)
- **Tentacles until Death:** 1 tentacle
- **Strategy:** Extremely dangerous, one tentacle = death
- **Upgrade Priority:** Survival powers (healing, defensive, rerolls)

---

## Impact on Power Analysis

### Tentacle Risk Calculation
- **Base tentacle risk:** Probability of rolling tentacles
- **Insanity-adjusted risk:** Tentacles = death risk
- **Value of avoiding tentacles:** Increases with insanity level

### Green Dice Value
- **No tentacles:** Green dice = pure benefit
- **Value increases:** As insanity rises, green dice become more valuable
- **Trade-off:** Green dice vs other power benefits

### Reroll Value
- **Avoid tentacles:** Reroll tentacles to avoid insanity
- **Get successes:** Reroll blanks to get successes
- **Value increases:** As insanity rises, rerolls become critical

### Upgrade Optimization
- **Limited upgrades:** Only 6 total, must optimize
- **Early vs Late:** Early upgrades benefit longer
- **Synergy:** Upgrade powers that work well together
- **Survival:** Late upgrades should focus on survival

---

## Power Combination Examples

### Example 1: Tentacle Avoidance
**Powers:**
- Arcane Mastery (elder signs → successes)
- Reroll power

**Combined Effect:**
- Elder signs become successes (no tentacles)
- Can reroll tentacles to avoid insanity
- Reduces insanity progression significantly

### Example 2: Green Dice Stacking
**Powers:**
- Marksman (adds green dice when attacking)
- Red Swirl bonuses (permanent green dice)

**Combined Effect:**
- More green dice = fewer tentacles
- Safer rolls = slower insanity progression
- Can afford to roll more aggressively

### Example 3: Defensive Stacking
**Powers:**
- Toughness (reduces damage)
- Healing powers

**Combined Effect:**
- Take less damage = fewer Rest actions needed
- More actions for offense/utility
- Survive longer = more time to benefit from upgrades

---

## Models & Implementation

### InsanityTrack Model
```python
class InsanityTrack(BaseModel):
    max_insanity: int = 20
    current_insanity: int = 1  # Starts at slot 1
    death_threshold: int = 21  # Slot 21 = death
    
    red_swirl_slots: List[int] = [5, 9, 13, 16, 19, 20]
    green_dice_red_swirls: List[int] = [2, 4, 5, 6]
    
    def take_tentacle(self, count: int = 1, stop_at_red_swirl: bool = True) -> tuple[int, bool]
        """Take tentacles, optionally stopping at red swirl."""
    
    def take_tentacles_in_roll(self, tentacle_count: int) -> tuple[int, bool, Optional[int]]
        """Take tentacles during a roll, stopping at red swirls.
        
        Returns: (insanity_gained, reached_red_swirl, red_swirl_number)
        """
    
    def reached_new_red_swirl(self) -> bool
        """Check if current insanity is at a red swirl."""
    
    def get_red_swirl_number(self, slot: int) -> Optional[int]
        """Get red swirl number (1-6) for a slot, or None."""
    
    @property
    def red_swirls_reached(self) -> int
    @property
    def level_ups_available(self) -> int
    @property
    def green_dice_bonus(self) -> int
    @property
    def tentacles_until_death(self) -> int
    @property
    def tentacles_until_next_red_swirl(self) -> Optional[int]
    @property
    def next_red_swirl(self) -> Optional[int]
```

---

## Optimization Considerations

### When to Prioritize Tentacle Avoidance
- High insanity (slots 15+)
- Close to death (slots 18+)
- Powers that reduce tentacle risk become critical

### When to Prioritize Green Dice
- Any insanity level (green dice always valuable)
- Especially valuable at high insanity (slots 15+)
- Powers that add green dice = permanent tentacle reduction

### When to Prioritize Rerolls
- High insanity (slots 15+)
- Need to avoid tentacles
- Can reroll tentacles to successes/elder signs

### When to Prioritize Upgrades
- Early game: Offensive powers (more time to benefit)
- Mid game: Balanced powers
- Late game: Defensive/survival powers

---

**Status:** Documented  
**Last Updated:** 2024-12-19

