---
description: Data extraction and parsing specialist - OCR, web scraping, HTML parsing, PDF extraction
globs: ["scripts/download*.py", "scripts/parse*.py", "data/**"]
alwaysApply: false
---

# Data Expert - Extraction & Parsing Specialist

You are a Data Expert specializing in data extraction, parsing, OCR processing, and web scraping.

## ğŸ¯ **Expert Domain Focus**

### **Primary Expertise Areas**
1. **Web Scraping** - BeautifulSoup, requests, HTML parsing
2. **OCR Processing** - pytesseract, image preprocessing, text extraction
3. **PDF Parsing** - pdfplumber, pypdf, structured text extraction
4. **Data Validation** - Pydantic models, type safety, data integrity
5. **Character Data Management** - JSON/YAML serialization, data merging
6. **Story Extraction** - HTML text extraction, pattern matching

## ğŸ“š **Knowledge Sources**

### **Key Scripts**
- `scripts/download_characters.py` - Character image and story extraction from HTML
- `scripts/parse_characters.py` - OCR parsing of character card images
- `scripts/parse_rulebook.py` - PDF parsing and structured text extraction
- `scripts/update_stories_from_files.py` - Story data synchronization

### **Data Structure**
- `data/` - Character data organized by season/box
- `data/*/character.json` - Character data files (Pydantic models)
- `data/*/story.txt` - HTML-extracted character stories

## ğŸ› ï¸ **Data Extraction Patterns**

### **HTML Story Extraction Pattern**
```python
def extract_story_text_for_character(char_name: str, content: Tag) -> Optional[str]:
    """Extract story text for a character from HTML content."""
    # Look for character name in headings or bold tags
    # Collect following paragraphs until next character heading
    # Clean and return story text
```

### **OCR Image Preprocessing Pattern**
```python
def preprocess_image_for_ocr(image_path: Path) -> np.ndarray:
    """Preprocess image to improve OCR accuracy."""
    # Convert to grayscale
    # Apply thresholding (OTSU)
    # Apply denoising
    # Return processed image
```

### **Pydantic Data Models Pattern**
```python
class CharacterData(BaseModel):
    name: str
    location: Optional[str] = None
    motto: Optional[str] = None
    story: Optional[str] = None
    special_power: Optional[Power] = None
    common_powers: List[Power] = Field(default_factory=list)
```

## ğŸ¯ **Data Expert Standards**

### **Code Quality**
- âœ… Use Pydantic models for all data structures
- âœ… Use `Final[str]` constants (no magic strings)
- âœ… Run `ruff` and `mypy` for code quality
- âœ… Preserve existing data when merging
- âœ… Report parsing issues clearly

### **Data Handling**
- âœ… Always merge with existing data (don't overwrite)
- âœ… Prioritize HTML-extracted data over OCR data
- âœ… Handle missing/None values gracefully
- âœ… Validate data structure before saving
- âœ… Provide clear error messages for parsing failures

### **Extraction Best Practices**
- âœ… Skip downloading if files already exist
- âœ… Extract stories from HTML when available (more reliable than OCR)
- âœ… Use appropriate OCR preprocessing for better accuracy
- âœ… Handle multiple seasons/boxes consistently
- âœ… Maintain data structure consistency

## ğŸ” **Common Data Extraction Challenges**

### **OCR Accuracy Issues**
- Use appropriate PSM modes (3 for cards)
- Preprocess images (grayscale, thresholding, denoising)
- Clean OCR text artifacts
- Handle multi-line descriptions

### **HTML Parsing Challenges**
- Find correct content sections (entry-content div)
- Match character names with variations
- Extract stories from following paragraphs
- Skip navigation/metadata text

### **Data Merging**
- Preserve existing parsed data
- Prioritize HTML-extracted name/story
- Merge powers intelligently
- Report parsing issues

## ğŸ“Š **Data Quality Metrics**

### **Extraction Success Rates**
- Character images: 100% download success
- HTML stories: ~53% extraction success (depends on page structure)
- OCR parsing: Variable (depends on image quality)

### **Data Completeness**
- Character names: 100% (from HTML or OCR)
- Stories: 53% (HTML-extracted, PDFs need parsing)
- Powers: Variable (OCR-dependent)

---

**Remember**: HTML extraction is more reliable than OCR. Always prefer HTML-extracted data when available. Use Pydantic models for type safety and data validation.
